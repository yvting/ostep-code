\documentclass{article}[10pt]

\usepackage{amsmath}
\usepackage{fullpage}
\usepackage{times}
\usepackage{listings}
\usepackage{xspace}

\lstset
{ %Formatting for code in appendix
    language=C,
    basicstyle=\footnotesize\ttfamily,
    numbers=left,
    stepnumber=1,
    showstringspaces=false,
    tabsize=1,
    breaklines=true,
    breakatwhitespace=false,
}

\usepackage{amsthm}

\newtheorem{mydef}{Definition}
\newtheorem{mythm}[mydef]{Theorem}

\newcommand{\kwd}[1]{\ensuremath{\text{\ttfamily #1}}\xspace}

\def\kflag{\kwd{flag}}
\def\kv{\kwd{v}}
\def\kturn{\kwd{turn}}
\def\kmyturn{\kwd{myturn}}
\def\kticket{\kwd{ticket}}



\title{The Correctness Proofs of Lock Algorithms}
\author{Yuting Wang}
\date{Feb 14th, 2021}


\begin{document}
\maketitle

\section{Correctness of the Spin Lock using Atomic Exchange}
\label{sec:spin-lock-xchg}

\begin{mythm}[Correctness of the Spin Lock with One Critical Section]
\label{thm:spin-lock-correct-xchg}

The following code shows the implementation of a spin lock as
described in Operating Systems: Three Easy Pieces.
%
\begin{lstlisting}
  typedef struct __lock_t {
    int flag;
  } lock_t;

  void init(lock_t *lock) {
    // 0: lock is available, 1: lock is held
    lock->flag = 0;
  }

  void lock(lock_t *lock) {
    int v;
    tst: v = TestAndSet(&lock->flag, 1);
    if (v == 1) goto tst; // spin-wait (do nothing)
    // acquire the lock
  }

  void unlock(lock_t *lock) {
    lock->flag = 0; // release the lock
  }  
\end{lstlisting}
%
Suppose the spin lock is used with one critical section as follows
where the lock and unlock functions are inlined:
%
\begin{lstlisting}
  // The beginning of the code
  // flag == 0
  ...
  int v;
  tst: v = TestAndSet(&flag, 1);
  if (v == 1) goto tst;
  // Beginning of the critical section
  ...
  flag = 0; // End of the critical section
  ...
\end{lstlisting}
%
Here, only line 5 and 9 can change the value of \kflag.
%
Suppose also that $n (n > 1)$ threads start their execution from the
beginning, then at any moment there is at most one thread executing in
the critical section.
\end{mythm}
%
\begin{proof}
  First, we define \emph{critical threads}. 
  \begin{quote}
    A thread is critical if its \kwd{PC} is either in the critical
    section (lines 7-9) or in the spin loop (line 6) with $\kv ==
    0$. Otherwise, it is not critical (non-critical), i.e., it is not in the critical
    section and if it is in the spin loop then $\kv == 1$.
  \end{quote}
  %
  We design the following invariant:
  \begin{quote}
    At any point of execution, only one of the following conditions hold:
    \begin{itemize}
    \item Every thread is non-critical and $\kflag == 0$;
    \item Exactly one thread is critical and $\kflag == 1$.
    \end{itemize}
  \end{quote}
  % 
  We show that the above condition is indeed an
  invariant. Obviously, it holds at the beginning of the execution as
  every thread is non-critical and $\kflag == 0$ at the start. We also
  need to show that if the invariant holds before one step of
  execution, then it also holds after. We consider all the possible cases
  of one-step execution listed below:
  %
  \begin{itemize}
  \item If every thread is non-critical and $\kflag == 0$, then a
    non-critical thread $t$ can only step in one of the following ways:
    %
    \begin{itemize}
    \item $t$ is not in the critical section or the spin loop. 

      \begin{itemize}
      \item If \kwd{PC} is at lines 1-4, then after the execution $t$
        is still not in the critical section or the spin loop and
        \kflag is unchanged. Therefore, the first condition of the
        invariant still holds;

      \item If \kwd{PC} is at line 5, then after the execution, we
        have $\kflag == 1$ and $v == 0$. By definition, $t$ becomes
        the one and the only critical thread. Now, the second
        condition of the invariant holds;

      \item If \kwd{PC} is at line 10, then obviously the first
        condition of the invariant still holds.

      \end{itemize}


    \item If $t$ is in the spin loop with $\kv == 1$, then obviously
      $t$ is non-critical after the execution and $\kflag$ is
      unchanged. Therefore, the first condition of the invariant
      holds.

    \end{itemize}
    
  \item If there is only one critical thread $t$ and $\kflag == 1$,
    then either $t$ executes one step or a non-critical thread $t'$
    executes one step. When $t$ executes, there are the following
    cases to consider:
    %
    \begin{itemize}
    \item If \kwd{PC} is at line 6 with $\kv == 0$, then $t$ goes into
      the critical section and \kflag is unchanged. The second
      condition of the invariant still holds;

    \item If \kwd{PC} is at lines 7-8, then $t$ stays in the critical
      section with \kflag unchanged. The second condition of the
      invariant still holds;

    \item If \kwd{PC} is at line 9, then $t$ goes out of the critical
      section (becomes non-critical) and $\kflag == 0$ after
      the execution. Because $t$ is the only critical thread, the first
      condition of the invariant holds after the execution.
    \end{itemize}
    %
    When $t'$ executes, there are the following cases to consider:
    %
    \begin{itemize}
    \item $t'$ is not in the critical section or the spin loop. 
      %
      \begin{itemize}
      \item If \kwd{PC} is at lines 1-4, then $t'$ is still
        non-critical and \kflag is unchanged after the execution. The
        second condition of the invariant still holds;

      \item If \kwd{PC} is at line 5, then after the execution, we
        still have $\kflag == 1$ and $v == 1$. By definition, $t'$ is
        still non-critical. Therefore, the second condition of the
        invariant still holds;

      \item If \kwd{PC} is at line 10, then obviously the second
        condition of the invariant still holds.

      \end{itemize}

      \item If $t$ is in the spin loop with $\kv == 1$, then obviously
        $t$ is non-critical after the execution and $\kflag$ is
        unchanged. Therefore, the second condition of the invariant
        still holds.
    \end{itemize}
  \end{itemize}
\end{proof}

Theorem~\ref{thm:spin-lock-correct-xchg} can easily generalized to deal
with critical sections with multiple entry and exit points. The only
requirement is that to reach any exit point the execution must first
go through an entry point. It can also be generalized to deal with
multiple critical sections.


\section{Correctness of the Spin Lock using Compare-and-swap(CAS)}
\label{sec:spin-lock-cas}

\begin{mythm}[Correctness of the Spin Lock with One Critical Section]
\label{thm:spin-lock-correct-cas}

An alternative way to implement the spin lock is to use
Compare-and-swap (CSA) as follows (where the other lock operations are
unchanged):
%
\begin{lstlisting}
  ...

  int CompareAndSwap(int *ptr, int expected, int new) {
    if (*ptr != expected)
       return 0;
      
    *ptr = new;
    return 1;
  }

  void lock(lock_t *lock) {
    int v;
    tst: v = CompareAndSwap(&lock->flag, 0, 1);
    if (v == 0) goto tst; // spin-wait (do nothing)
    // acquire the lock
  }

  ...
\end{lstlisting}
%
Then the following code uses the spin lock with one critical section:
%
\begin{lstlisting}
  // The beginning of the code
  // flag == 0
  ...
  int v;
  tst: v = CompareAndSwap(&flag, 0, 1);
  if (v == 0) goto tst;
  // Beginning of the critical section
  ...
  flag = 0; // End of the critical section
  ...
\end{lstlisting}
%
Here, only line 5 and 9 can change the value of \kflag.
%
Suppose also that $n (n > 1)$ threads start their execution from the
beginning, then at any moment there is at most one thread executing in
the critical section.
\end{mythm}
%
\begin{proof}
  The proof is mostly similar to that of
  Theorem~\ref{thm:spin-lock-correct-xchg}. We discuss it below.

  First, we define \emph{critical threads}. 
  \begin{quote}
    A thread is critical if its \kwd{PC} is either in the critical
    section (lines 7-9) or in the spin loop (line 6) with $\kv ==
    1$. Otherwise, it is not critical (non-critical), i.e., it is not in the critical
    section and if it is in the spin loop then $\kv == 0$.
  \end{quote}
  %
  We design the following invariant:
  \begin{quote}
    At any point of execution, only one of the following conditions hold:
    \begin{itemize}
    \item Every thread is non-critical and $\kflag == 0$;
    \item Exactly one thread is critical and $\kflag == 1$.
    \end{itemize}
  \end{quote}
  % 
  We show that the above condition is indeed an
  invariant. Obviously, it holds at the beginning of the execution as
  every thread is non-critical and $\kflag == 0$ at the start. We also
  need to show that if the invariant holds before one step of
  execution, then it also holds after. We consider all the possible cases
  of one-step execution listed below:
  %
  \begin{itemize}
  \item If every thread is non-critical and $\kflag == 0$, then a
    non-critical thread $t$ can only step in one of the following ways:
    %
    \begin{itemize}
    \item $t$ is not in the critical section or the spin loop. 

      \begin{itemize}
      \item If \kwd{PC} is at lines 1-4, then after the execution $t$
        is still not in the critical section or the spin loop and
        \kflag is unchanged. Therefore, the first condition of the
        invariant still holds;

      \item If \kwd{PC} is at line 5, then after the execution, we
        have $\kflag == 1$ and $v == 1$. By definition, $t$ becomes
        the one and the only critical thread. Now, the second
        condition of the invariant holds;

      \item If \kwd{PC} is at line 10, then obviously the first
        condition of the invariant still holds.

      \end{itemize}


    \item If $t$ is in the spin loop with $\kv == 0$, then obviously
      $t$ is non-critical after the execution and $\kflag$ is
      unchanged. Therefore, the first condition of the invariant
      holds.

    \end{itemize}
    
  \item If there is only one critical thread $t$ and $\kflag == 1$,
    then either $t$ executes one step or a non-critical thread $t'$
    executes one step. When $t$ executes, there are the following
    cases to consider:
    %
    \begin{itemize}
    \item If \kwd{PC} is at line 6 with $\kv == 1$, then $t$ goes into
      the critical section and \kflag is unchanged. The second
      condition of the invariant still holds;

    \item If \kwd{PC} is at lines 7-8, then $t$ stays in the critical
      section with \kflag unchanged. The second condition of the
      invariant still holds;

    \item If \kwd{PC} is at line 9, then $t$ goes out of the critical
      section (becomes non-critical) and $\kflag == 0$ after
      the execution. Because $t$ is the only critical thread, the first
      condition of the invariant holds after the execution.
    \end{itemize}
    %
    When $t'$ executes, there are the following cases to consider:
    %
    \begin{itemize}
    \item $t'$ is not in the critical section or the spin loop. 
      %
      \begin{itemize}
      \item If \kwd{PC} is at lines 1-4, then $t'$ is still
        non-critical and \kflag is unchanged after the execution. The
        second condition of the invariant still holds;

      \item If \kwd{PC} is at line 5, then after the execution, we
        still have $\kflag == 1$ and $v == 0$. By definition, $t'$ is
        still non-critical. Therefore, the second condition of the
        invariant still holds;

      \item If \kwd{PC} is at line 10, then obviously the second
        condition of the invariant still holds.

      \end{itemize}

      \item If $t$ is in the spin loop with $\kv == 0$, then obviously
        $t$ is non-critical after the execution and $\kflag$ is
        unchanged. Therefore, the second condition of the invariant
        still holds.
    \end{itemize}
  \end{itemize}
  
\end{proof}


\section{Correctness of a Ticket Lock Algorithm}
\label{sec:ticket-lock}

\begin{mythm}[Correctness of the Ticket Lock with One Critical Section]
\label{thm:ticket-lock-correct}

The semantics of a fetch-and-add instruction is defined as follows:
%
\begin{lstlisting}
  int FetchAndAdd(int *ptr) {
    int old = *ptr;
    *ptr = old + 1;
    return old;
  }  
\end{lstlisting}
%
The ticket lock is then implemented as follows:
%
\begin{lstlisting}
  typedef struct __lock_t {
    int ticket;
    int turn;
  } lock_t;

  void lock_init(lock_t *lock) {
    lock->ticket = 0;
    lock->turn = 0;
  }

  void lock(lock_t *lock) {
    int myturn = FetchAndAdd(&lock->ticket);
    while (lock->turn != myturn)
    ; // spin
  }

  void unlock(lock_t *lock) {
    lock->turn = lock->turn + 1;
  }  
\end{lstlisting}
%
Suppose the ticket lock is used with one critical section as follows
where the lock and unlock functions are inlined:
%
\begin{lstlisting}
  // The beginning of the code
  // flag == 0
  ...
  int myturn;
  myturn = FetchAndAdd(&ticket);
  tst: if (turn != myturn) goto tst;
  // Beginning of the critical section
  ...
  int v;
  v = turn + 1; 
  turn = v;// End of the critical section
  ...
\end{lstlisting}
%
Here, only line 5 changes the value of \kticket and only line 11
changes the value of \kturn.
%
Suppose also that $n (n > 1)$ threads start their execution from the
beginning, then at any moment there is at most one thread executing in
the critical section.
\end{mythm}
%
\begin{proof}
  First, we define \emph{critical threads}. 
  \begin{quote}
    A thread is critical if its \kwd{PC} is either in the critical
    section (lines 7-11) or in the spin loop (line 6) with $\kturn ==
    \kmyturn$. Otherwise, it is either not critical
    (non-critical)---i.e., it is not in the critical section or the
    spin loop---or waiting---i.e., it is in the spin loop (line 6)
    with $\kturn \not= \kmyturn$.
  \end{quote}
  %
  We design the following invariant:
  \begin{quote}
    At any point of execution, $\kticket \geq \kturn$ and:
    \begin{itemize}
    \item if $\kticket == \kturn$, then every thread is non-critical;
    \item if $\kticket > \kturn$, then there is exactly one thread
      that is critical and there is $\kticket - \kturn - 1$ waiting
      threads.
    \end{itemize}
  \end{quote}
  % 
  We show that the above condition is indeed an
  invariant. Obviously, it holds at the beginning of the execution as
  every thread is non-critical and $\kticket == \kturn == 0$ at the
  start. We also need to show that if the invariant holds before one
  step of execution, then it also holds after. We consider all the
  possible cases of one-step execution listed below:
  %
  \begin{itemize}
  \item $\kticket == \kturn$ and every thread is non-critical. In this
    case, a non-critical thread $t$ can only step in one of the
    following ways:
    %
    \begin{itemize}
    \item If \kwd{PC} is at lines 1-4, then after the execution $t$
      is still not in the critical section or the spin loop and
      \kflag is unchanged. Therefore, the first condition of the
      invariant still holds;

    \item If \kwd{PC} is at line 5, then after the execution, we
      have $\kflag == 1$ and $v == 0$. By definition, $t$ becomes
      the one and the only critical thread. Now, the second
      condition of the invariant holds.

    \end{itemize}

  \end{itemize}

  \begin{itemize}
  \item If every thread is non-critical and $\kflag == 0$, then a
    non-critical thread $t$ can only step in one of the following ways:
    %
    \begin{itemize}
    \item $t$ is not in the critical section or the spin loop. 

      \begin{itemize}
      \item If \kwd{PC} is at lines 1-4, then after the execution $t$
        is still not in the critical section or the spin loop and
        \kflag is unchanged. Therefore, the first condition of the
        invariant still holds;

      \item If \kwd{PC} is at line 5, then after the execution, we
        have $\kflag == 1$ and $v == 0$. By definition, $t$ becomes
        the one and the only critical thread. Now, the second
        condition of the invariant holds.

      \end{itemize}


    \item If $t$ is in the spin loop with $\kv == 1$, then obviously
      $t$ is non-critical after the execution and $\kflag$ is
      unchanged. Therefore, the first condition of the invariant
      holds.

    \end{itemize}
    
  \item If there is only one critical thread $t$ and $\kflag == 1$,
    then either $t$ executes one step or a non-critical thread $t'$
    executes one step. When $t$ executes, there are the following
    cases to consider:
    %
    \begin{itemize}
    \item If \kwd{PC} is at line 6 with $\kv == 0$, then $t$ goes into
      the critical section and \kflag is unchanged. The second
      condition of the invariant still holds;

    \item If \kwd{PC} is at lines 7-8, then $t$ stays in the critical
      section with \kflag unchanged. The second condition of the
      invariant still holds;

    \item If \kwd{PC} is at line 9, then $t$ goes out of the critical
      section (becomes non-critical) and $\kflag == 0$ after
      the execution. Because $t$ is the only critical thread, the first
      condition of the invariant holds after the execution.
    \end{itemize}
    %
    When $t'$ executes, there are the following cases to consider:
    %
    \begin{itemize}
    \item $t'$ is not in the critical section or the spin loop. 
      %
      \begin{itemize}
      \item If \kwd{PC} is at lines 1-4, then $t'$ is still
        non-critical and \kflag is unchanged after the execution. The
        second condition of the invariant still holds;

      \item If \kwd{PC} is at line 5, then after the execution, we
        still have $\kflag == 1$ and $v == 1$. By definition, $t'$ is
        still non-critical. Therefore, the second condition of the
        invariant still holds.

      \end{itemize}

      \item If $t$ is in the spin loop with $\kv == 1$, then obviously
        $t$ is non-critical after the execution and $\kflag$ is
        unchanged. Therefore, the second condition of the invariant
        still holds.
    \end{itemize}
  \end{itemize}
\end{proof}


\end{document}
